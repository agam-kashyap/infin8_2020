{"ast":null,"code":"import _classCallCheck from \"@babel/runtime/helpers/esm/classCallCheck\";\nimport _createClass from \"@babel/runtime/helpers/esm/createClass\";\nimport _possibleConstructorReturn from \"@babel/runtime/helpers/esm/possibleConstructorReturn\";\nimport _getPrototypeOf from \"@babel/runtime/helpers/esm/getPrototypeOf\";\nimport _assertThisInitialized from \"@babel/runtime/helpers/esm/assertThisInitialized\";\nimport _inherits from \"@babel/runtime/helpers/esm/inherits\";\nimport _defineProperty from \"@babel/runtime/helpers/esm/defineProperty\";\nimport React, { PureComponent, cloneElement } from 'react';\nimport PropTypes from 'prop-types';\nimport MapContext from './map-context';\nimport assert from '../utils/assert';\nvar propTypes = {\n  type: PropTypes.string.isRequired,\n  id: PropTypes.string\n};\nvar sourceCounter = 0;\n\nvar Source = function (_PureComponent) {\n  _inherits(Source, _PureComponent);\n\n  function Source(_props) {\n    var _this;\n\n    _classCallCheck(this, Source);\n\n    _this = _possibleConstructorReturn(this, _getPrototypeOf(Source).call(this, _props));\n\n    _defineProperty(_assertThisInitialized(_this), \"id\", void 0);\n\n    _defineProperty(_assertThisInitialized(_this), \"type\", void 0);\n\n    _defineProperty(_assertThisInitialized(_this), \"_map\", null);\n\n    _defineProperty(_assertThisInitialized(_this), \"_sourceOptions\", {});\n\n    _defineProperty(_assertThisInitialized(_this), \"_updateSource\", function () {\n      var _assertThisInitialize = _assertThisInitialized(_this),\n          type = _assertThisInitialize.type,\n          map = _assertThisInitialize._map;\n\n      if (!map) {\n        return;\n      }\n\n      var _assertThisInitialize2 = _assertThisInitialized(_this),\n          sourceOptions = _assertThisInitialize2._sourceOptions,\n          props = _assertThisInitialize2.props;\n\n      assert(!props.id || props.id === _this.id, 'source id changed');\n      assert(props.type === type, 'source type changed');\n      var changedKey = null;\n      var changedKeyCount = 0;\n\n      for (var key in props) {\n        if (key !== 'children' && key !== 'id' && sourceOptions[key] !== props[key]) {\n          sourceOptions[key] = props[key];\n          changedKey = key;\n          changedKeyCount++;\n        }\n      }\n\n      var source = _this.getSource();\n\n      if (!source) {\n        _this._createSource(sourceOptions);\n\n        return;\n      }\n\n      if (!changedKeyCount) {\n        return;\n      }\n\n      if (type === 'geojson') {\n        source.setData(sourceOptions.data);\n      } else if (type === 'image') {\n        source.updateImage({\n          url: sourceOptions.url,\n          coordinates: sourceOptions.coordinates\n        });\n      } else if ((type === 'canvas' || type === 'video') && changedKeyCount === 1 && changedKey === 'coordinates') {\n        source.setCoordinates(sourceOptions.coordinates);\n      } else {\n        map.removeSource(_this.id);\n        map.addSource(_this.id, sourceOptions);\n      }\n    });\n\n    _this.id = _props.id || \"jsx-source-\".concat(sourceCounter++);\n    _this.type = _props.type;\n    return _this;\n  }\n\n  _createClass(Source, [{\n    key: \"componentWillUnmount\",\n    value: function componentWillUnmount() {\n      var _this2 = this;\n\n      var map = this._map;\n\n      if (map) {\n        map.off('styledata', this._updateSource);\n\n        if (map.style) {\n          requestAnimationFrame(function () {\n            return map.removeSource(_this2.id);\n          });\n        }\n      }\n    }\n  }, {\n    key: \"getSource\",\n    value: function getSource() {\n      var map = this._map;\n      return map && map.style && map.getSource(this.id);\n    }\n  }, {\n    key: \"_createSource\",\n    value: function _createSource(sourceOptions) {\n      var map = this._map;\n\n      if (map.style && map.style._loaded) {\n        map.addSource(this.id, sourceOptions);\n      }\n    }\n  }, {\n    key: \"_render\",\n    value: function _render(context) {\n      var _this3 = this;\n\n      if (!this._map) {\n        this._map = context.map;\n\n        this._map.on('styledata', this._updateSource);\n      }\n\n      this._updateSource();\n\n      return React.Children.map(this.props.children, function (child) {\n        return cloneElement(child, {\n          source: _this3.id\n        });\n      });\n    }\n  }, {\n    key: \"render\",\n    value: function render() {\n      return React.createElement(MapContext.Consumer, null, this._render.bind(this));\n    }\n  }]);\n\n  return Source;\n}(PureComponent);\n\n_defineProperty(Source, \"propTypes\", propTypes);\n\nexport { Source as default };","map":{"version":3,"sources":["../../../src/components/source.js"],"names":["propTypes","type","PropTypes","id","string","sourceCounter","Source","PureComponent","props","map","requestAnimationFrame","sourceOptions","assert","changedKey","changedKeyCount","key","source","url","coordinates","context","cloneElement"],"mappings":"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","sourcesContent":["// @flow\n// Copyright (c) 2015 Uber Technologies, Inc.\n\n// Permission is hereby granted, free of charge, to any person obtaining a copy\n// of this software and associated documentation files (the \"Software\"), to deal\n// in the Software without restriction, including without limitation the rights\n// to use, copy, modify, merge, publish, distribute, sublicense, and/or sell\n// copies of the Software, and to permit persons to whom the Software is\n// furnished to do so, subject to the following conditions:\n\n// The above copyright notice and this permission notice shall be included in\n// all copies or substantial portions of the Software.\n\n// THE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR\n// IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,\n// FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE\n// AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER\n// LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,\n// OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN\n// THE SOFTWARE.\nimport React, {PureComponent, cloneElement} from 'react';\nimport PropTypes from 'prop-types';\nimport MapContext from './map-context';\nimport assert from '../utils/assert';\n\nimport type {MapContextProps} from './map-context';\n\nconst propTypes = {\n  type: PropTypes.string.isRequired,\n  id: PropTypes.string\n};\n\ntype SourceProps = {\n  id?: string,\n  type: string,\n  children?: any\n};\n\nlet sourceCounter = 0;\n\nexport default class Source<Props: SourceProps> extends PureComponent<Props> {\n  static propTypes = propTypes;\n\n  constructor(props: Props) {\n    super(props);\n    this.id = props.id || `jsx-source-${sourceCounter++}`;\n    this.type = props.type;\n  }\n\n  componentWillUnmount() {\n    /* global requestAnimationFrame */\n    // Do not remove source immediately because the\n    // dependent <Layer>s' componentWillUnmount() might not have been called\n    // Removing source before dependent layers will throw error\n    // TODO - find a more robust solution\n    const map = this._map;\n    if (map) {\n      map.off('styledata', this._updateSource);\n      if (map.style) {\n        requestAnimationFrame(() => map.removeSource(this.id));\n      }\n    }\n  }\n\n  id: string;\n  type: string;\n  _map: any = null;\n  _sourceOptions: any = {};\n\n  getSource() {\n    const map = this._map;\n    return map && map.style && map.getSource(this.id);\n  }\n\n  _createSource(sourceOptions: any) {\n    const map = this._map;\n    if (map.style && map.style._loaded) {\n      map.addSource(this.id, sourceOptions);\n    }\n  }\n\n  /* eslint-disable complexity */\n  _updateSource = () => {\n    const {type, _map: map} = this;\n    if (!map) {\n      return;\n    }\n\n    const {_sourceOptions: sourceOptions, props} = this;\n    assert(!props.id || props.id === this.id, 'source id changed');\n    assert(props.type === type, 'source type changed');\n\n    let changedKey = null;\n    let changedKeyCount = 0;\n\n    for (const key in props) {\n      if (key !== 'children' && key !== 'id' && sourceOptions[key] !== props[key]) {\n        sourceOptions[key] = props[key];\n        changedKey = key;\n        changedKeyCount++;\n      }\n    }\n\n    const source = this.getSource();\n    if (!source) {\n      this._createSource(sourceOptions);\n      return;\n    }\n    if (!changedKeyCount) {\n      return;\n    }\n    if (type === 'geojson') {\n      source.setData(sourceOptions.data);\n    } else if (type === 'image') {\n      source.updateImage({url: sourceOptions.url, coordinates: sourceOptions.coordinates});\n    } else if (\n      (type === 'canvas' || type === 'video') &&\n      changedKeyCount === 1 &&\n      changedKey === 'coordinates'\n    ) {\n      source.setCoordinates(sourceOptions.coordinates);\n    } else {\n      map.removeSource(this.id);\n      map.addSource(this.id, sourceOptions);\n    }\n  };\n  /* eslint-enable complexity */\n\n  _render(context: MapContextProps) {\n    if (!this._map) {\n      this._map = context.map;\n      this._map.on('styledata', this._updateSource);\n    }\n    this._updateSource();\n    return React.Children.map(this.props.children, child =>\n      cloneElement(child, {\n        source: this.id\n      })\n    );\n  }\n\n  render() {\n    return <MapContext.Consumer>{this._render.bind(this)}</MapContext.Consumer>;\n  }\n}\n"]},"metadata":{},"sourceType":"module"}